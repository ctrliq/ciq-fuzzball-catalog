// 06f42b20-395b-4d1a-82f5-c4951adb0785

echo " \x76657273696f6e3a2076310a0a766f6c756d65733a0a2020736372617463683a0a202020207265666572656e63653a207b7b2e53637261746368566f6c756d657d7d0a0a6a6f62733a0a20207273747564696f3a0a202020206e616d653a205273747564696f0a20202020656e763a0a2020202020202d20484f4d453d2f736372617463680a2020202020202d204c435f414c4c3d656e5f55532e5554462d380a20202020696d6167653a0a2020202020207572693a207b7b2e436f6e7461696e65727d7d0a202020206d6f756e74733a0a202020202020736372617463683a0a20202020202020206c6f636174696f6e3a202f736372617463680a20202020706f6c6963793a0a20202020202074696d656f75743a0a2020202020202020657865637574653a207b7b2e54696d656f75747d7d0a20202020636f6d6d616e643a0a2020202020202d202f62696e2f626173680a2020202020202d20272d7863270a2020202020202d207c0a20202020202020207273747564696f5f6469723d2224286d6b74656d70202d64202f746d702f5858585829220a202020202020202050415353574f52443d2224283c202f6465762f7572616e646f6d207472202d646320412d5a612d7a302d39207c2068656164202d6322247b313a2d32347d2229220a202020202020202052414e444f4d3d242864617465202b2573290a2020202020202020504f52543d242828202852414e444f4d2025203130303029202b2032333030302029290a2020202020202020555345523d242877686f616d69290a20202020202020206578706f72742050415353574f524420555345520a202020202020202063642024484f4d450a0a20202020202020206563686f203e202e5270726f66696c65203c3c454f460a2020202020202020736574776428222f7363726174636822290a2020202020202020454f460a2020202020202020656e76203e20222e52656e7669726f6e220a0a20202020202020206d6b646972202d702022247b7273747564696f5f6469727d222f7b636f6e6669672c6c6f67732c7365727665722d646174612c7365727665722d776f726b696e672d6469722c64627d0a0a2020202020202020636174203e2022247b7273747564696f5f6469727d2f636f6e6669672f6c6f6767696e672e636f6e6622203c3c20454f460a20202020202020205b2a5d0a20202020202020206c6f672d6c6576656c3d64656275670a20202020202020206c6f676765722d747970653d66696c650a20202020202020206c6f672d6469723d247b7273747564696f5f6469727d2f6c6f67730a2020202020202020454f460a0a2020202020202020636174203e2022247b7273747564696f5f6469727d2f636f6e6669672f64617461626173652e636f6e6622203c3c20454f460a20202020202020206469726563746f72793d247273747564696f5f6469722f64620a2020202020202020454f460a0a0a2020202020202020636174203e2022247b7273747564696f5f6469727d2f636f6e6669672f7273657373696f6e2e636f6e6622203c3c20454f460a202020202020202073657373696f6e2d7270726f66696c652d6f6e2d726573756d652d64656661756c743d747275650a202020202020202073657373696f6e2d74696d656f75742d6d696e757465733d300a2020202020202020636f70696c6f742d656e61626c65643d310a202020202020202073657373696f6e2d64656661756c742d776f726b696e672d6469723d24484f4d450a202020202020202073657373696f6e2d64656661756c742d6e65772d70726f6a6563742d6469723d24484f4d450a2020202020202020454f460a0a2020202020202020636174203e2022247b7273747564696f5f6469727d2f636f6e6669672f727365727665722e636f6e6622203c3c20454f460a2020202020202020617574682d6e6f6e653d300a2020202020202020617574682d70616d2d68656c7065722d706174683d2f726f636b65725f736372697074732f70616d2d68656c7065722e73680a2020202020202020617574682d6d696e696d756d2d757365722d69643d313030300a2020202020202020617574682d6c6f67696e2d706167652d68746d6c3d247273747564696f5f6469722f636f6e6669672f6c6f67696e2e68746d6c0a2020202020202020617574682d74696d656f75742d6d696e757465733d300a2020202020202020617574682d737461792d7369676e65642d696e2d646179733d320a20202020202020207777772d616464726573733d3132372e302e302e310a20202020202020207777772d6672616d652d6f726967696e3d73616d650a20202020202020207777772d706f72743d24504f52540a20202020202020207777772d7665726966792d757365722d6167656e743d6e6f0a20202020202020207365727665722d6461656d6f6e697a653d6e6f0a20202020202020207365727665722d646174612d6469723d247273747564696f5f6469722f7365727665722d646174610a20202020202020207365727665722d7069642d66696c653d247273747564696f5f6469722f7273747564696f2e7069640a20202020202020207365727665722d757365723d242877686f616d69290a20202020202020207365727665722d776f726b696e672d6469723d247273747564696f5f6469722f7365727665722d776f726b696e672d6469720a2020202020202020454f460a0a0a202020202020202023207468697320637573746f6d206c6f67696e20706167652077696c6c206175746f2d6c6f67696e20776974682074686520757365726e616d6520616e642070772066726f6d207468652075726c0a2020202020202020636174203e2022247273747564696f5f6469722f636f6e6669672f6c6f67696e2e68746d6c22203c3c20454f460a20202020202020203c73637269707420747970653d22746578742f6a617661736372697074223e0a20202020202020202020202020636f6e73742075726c506172616d73203d206e65772055524c536561726368506172616d732877696e646f772e6c6f636174696f6e2e736561726368293b0a2020202020202020202020202076617220757365723b0a202020202020202020202020207661722070617373776f72643b0a2020202020202020202020202075736572203d2075726c506172616d732e67657428277573657227293b0a2020202020202020202020202070617373776f7264203d2075726c506172616d732e676574282770617373776f726427293b0a202020202020202020202020206966287573657220213d3d20756e646566696e656429207b0a2020202020202020202020202020202020646f63756d656e742e676574456c656d656e74427949642827757365726e616d6527292e76616c7565203d20757365723b0a202020202020202020202020207d0a202020202020202020202020206966287573657220213d3d20756e646566696e656429207b0a2020202020202020202020202020202020646f63756d656e742e676574456c656d656e7442794964282770617373776f726427292e76616c7565203d2070617373776f72643b0a202020202020202020202020207d0a202020202020202020202020206966287573657220213d3d20756e646566696e6564202626207573657220213d3d20756e646566696e656429207b0a2020202020202020202020202020202020646f63756d656e742e676574456c656d656e744279496428277369676e696e627574746f6e27292e636c69636b28293b0a202020202020202020202020207d0a20202020202020203c2f7363726970743e0a2020202020202020454f460a0a20202020202020207072696e746620225c6e53657420757020706f727420666f7277617264696e6720776974685c6e220a20202020202020207072696e74662022202066757a7a62616c6c20776f726b666c6f7720706f72742d666f7277617264202573207273747564696f2025733a25735c6e2220222446425f574f524b464c4f575f4944222022247b504f52547d222022247b504f52547d220a20202020202020207072696e746620225468656e20636f6e6e65637420746f205c6e220a20202020202020207072696e746620222020687474703a2f2f6c6f63616c686f73743a25732f617574682d7369676e2d696e3f757365723d25732670617373776f72643d25735c6e22202224504f525422202224555345522220222450415353574f5244220a20202020202020207072696e746620224c6f67696e2073686f756c642068617070656e206175746f6d61746963616c6c792e20496620697420646f6573206e6f742075736520757365726e616d65202725732720616e6420706173776f726420272573275c6e5c6e22202224555345522220222450415353574f5244220a0a20202020202020205253545544494f5f444154415f484f4d453d22247273747564696f5f6469722f7365727665722d6461746122205c0a20202020202020205253545544494f5f434f4e4649475f4449523d22247273747564696f5f6469722f636f6e66696722205c0a2020202020202020727365727665720a0a202020207265736f757263653a0a2020202020206370753a0a2020202020202020636f7265733a207b7b2e436f7265737d7d0a2020202020206d656d6f72793a0a202020202020202073697a653a207b7b2e4d656d6f72797d7d0a" | xxd -r -p

version: v1

volumes:
  scratch:
    reference: {{.ScratchVolume}}

jobs:
  rstudio:
    name: Rstudio
    env:
      - HOME=/scratch
      - LC_ALL=en_US.UTF-8
    image:
      uri: {{.Container}}
    mounts:
      scratch:
        location: /scratch
    policy:
      timeout:
        execute: {{.Timeout}}
    command:
      - /bin/bash
      - '-xc'
      - |
        rstudio_dir="$(mktemp -d /tmp/XXXX)"
        PASSWORD="$(< /dev/urandom tr -dc A-Za-z0-9 | head -c"${1:-24}")"
        RANDOM=$(date +%s)
        PORT=$(( (RANDOM % 1000) + 23000 ))
        USER=$(whoami)
        export PASSWORD USER
        cd $HOME

        echo > .Rprofile <<EOF
        setwd("/scratch")
        EOF
        env > ".Renviron"

        mkdir -p "${rstudio_dir}"/{config,logs,server-data,server-working-dir,db}

        cat > "${rstudio_dir}/config/logging.conf" << EOF
        [*]
        log-level=debug
        logger-type=file
        log-dir=${rstudio_dir}/logs
        EOF

        cat > "${rstudio_dir}/config/database.conf" << EOF
        directory=$rstudio_dir/db
        EOF


        cat > "${rstudio_dir}/config/rsession.conf" << EOF
        session-rprofile-on-resume-default=true
        session-timeout-minutes=0
        copilot-enabled=1
        session-default-working-dir=$HOME
        session-default-new-project-dir=$HOME
        EOF

        cat > "${rstudio_dir}/config/rserver.conf" << EOF
        auth-none=0
        auth-pam-helper-path=/rocker_scripts/pam-helper.sh
        auth-minimum-user-id=1000
        auth-login-page-html=$rstudio_dir/config/login.html
        auth-timeout-minutes=0
        auth-stay-signed-in-days=2
        www-address=127.0.0.1
        www-frame-origin=same
        www-port=$PORT
        www-verify-user-agent=no
        server-daemonize=no
        server-data-dir=$rstudio_dir/server-data
        server-pid-file=$rstudio_dir/rstudio.pid
        server-user=$(whoami)
        server-working-dir=$rstudio_dir/server-working-dir
        EOF


        # this custom login page will auto-login with the username and pw from the url
        cat > "$rstudio_dir/config/login.html" << EOF
        <script type="text/javascript">
             const urlParams = new URLSearchParams(window.location.search);
             var user;
             var password;
             user = urlParams.get('user');
             password = urlParams.get('password');
             if(user !== undefined) {
                 document.getElementById('username').value = user;
             }
             if(user !== undefined) {
                 document.getElementById('password').value = password;
             }
             if(user !== undefined && user !== undefined) {
                 document.getElementById('signinbutton').click();
             }
        </script>
        EOF

        printf "\nSet up port forwarding with\n"
        printf "  fuzzball workflow port-forward %s rstudio %s:%s\n" "$FB_WORKFLOW_ID" "${PORT}" "${PORT}"
        printf "Then connect to \n"
        printf "  http://localhost:%s/auth-sign-in?user=%s&password=%s\n" "$PORT" "$USER" "$PASSWORD"
        printf "Login should happen automatically. If it does not use username '%s' and pasword '%s'\n\n" "$USER" "$PASSWORD"

        RSTUDIO_DATA_HOME="$rstudio_dir/server-data" \
        RSTUDIO_CONFIG_DIR="$rstudio_dir/config" \
        rserver

    resource:
      cpu:
        cores: {{.Cores}}
      memory:
        size: {{.Memory}}