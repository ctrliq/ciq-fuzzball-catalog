echo "\x76657273696f6e3a2076310a766f6c756d65733a0a20206277612d646174613a0a20202020696e67726573733a0a2020202020202d20736f757263653a0a202020202020202020207572693a207b7b2e5265666572656e636547656e6f6d6555524c207c2064656661756c74202268747470733a2f2f6674702e6e6362692e6e6c6d2e6e69682e676f762f67656e6f6d65732f616c6c2f4743462f3030302f3030352f3834352f4743465f3030303030353834352e325f41534d35383476322f4743465f3030303030353834352e325f41534d35383476325f67656e6f6d69632e666e612e677a227d7d0a202020202020202064657374696e6174696f6e3a0a202020202020202020207572693a2066696c653a2f2f2f7265666572656e63652e66612e677a0a2020202020202d20736f757263653a0a202020202020202020207572693a207b7b2e526561643155524c207c2064656661756c74202268747470733a2f2f6674702d74726163652e6e6362692e6e6c6d2e6e69682e676f762f676961622f6674702f646174612f4e4131323837382f47617276616e5f4e4131323837385f48473030315f48695365715f45786f6d652f4e495354373033355f54414147474347415f4c3030315f52315f3030312e66617374712e677a227d7d0a202020202020202064657374696e6174696f6e3a0a202020202020202020207572693a2066696c653a2f2f2f73616d706c655f312e66617374712e677a0a2020202020202d20736f757263653a0a202020202020202020207572693a207b7b2e526561643255524c207c2064656661756c74202268747470733a2f2f6674702d74726163652e6e6362692e6e6c6d2e6e69682e676f762f676961622f6674702f646174612f4e4131323837382f47617276616e5f4e4131323837385f48473030315f48695365715f45786f6d652f4e495354373033355f54414147474347415f4c3030315f52325f3030312e66617374712e677a227d7d0a202020202020202064657374696e6174696f6e3a0a202020202020202020207572693a2066696c653a2f2f2f73616d706c655f322e66617374712e677a0a202020207265666572656e63653a20766f6c756d653a2f2f757365722f657068656d6572616c0a202020206567726573733a0a2020202020207b7b2d2072616e67652024736f757263652c202464657374203a3d20646963742022616c69676e65642e73616d222022616c69676e65642e73616d222022616c69676e65642e73746174732e747874222022616c69676e65642e73746174732e74787422202266696c74657265642e73616d22202266696c74657265642e73616d22207d7d0a2020202020202d20736f757263653a0a202020202020202020207572693a2066696c653a2f2f2f7b7b2024736f75726365207d7d0a202020202020202064657374696e6174696f6e3a0a202020202020202020207572693a207b7b242e45677265737344657374696e6174696f6e207c2064656661756c7420287072696e7466202273333a2f2f25732f25732573222028242e53334275636b6574207c2064656661756c7420226f75747075742d6275636b657422292028242e5333507265666978207c2064656661756c7420222229202464657374297d7d0a202020202020202020207b7b2d20696620242e5333536563726574207d7d0a202020202020202020207365637265743a207b7b20242e5333536563726574207d7d0a202020202020202020207b7b2d20656e64207d7d0a2020202020207b7b2d20656e64207d7d0a6a6f62733a0a20206277612d6d656d322d696e6465783a0a202020206377643a202f646174610a202020206e616d653a206277612d6d656d322d696e6465780a20202020696d6167653a0a2020202020207572693a207b7b2e436f6e7461696e6572496d616765207c2064656661756c742022646f636b65723a2f2f717561792e696f2f62696f636f6e7461696e6572732f6277612d6d656d323a322e322e312d2d68653531336663335f30227d7d0a202020206d6f756e74733a0a2020202020206277612d646174613a0a20202020202020206c6f636174696f6e3a202f646174610a20202020636f6d6d616e643a0a2020202020202d202f62696e2f626173680a2020202020202d20272d63270a2020202020202d207c0a20202020202020206966205b202d66207265666572656e63652e66612e677a205d202626205b2021202d66207265666572656e63652e6661205d3b207468656e0a2020202020202020202067756e7a6970202d66207265666572656e63652e66612e677a0a202020202020202066690a0a20202020202020206966205b202d66207265666572656e63652e6661205d202626205b2021202d66207265666572656e63652e66612e6277742e326269742e3634205d3b207468656e0a202020202020202020206277612d6d656d3220696e646578207265666572656e63652e66610a2020202020202020656c6966205b2021202d66207265666572656e63652e6661205d3b207468656e0a202020202020202020206578697420310a202020202020202066690a202020207265736f757263653a0a2020202020206370753a0a2020202020202020636f7265733a207b7b2e496e646578437075436f726573207c2064656661756c742031367d7d0a2020202020206d656d6f72793a0a202020202020202073697a653a207b7b2e496e6465784d656d6f7279207c2064656661756c742031367d7d4769420a2020202069643a206a6f622d7b7b2e4a6f624964207c2064656661756c7420226277616d656d32227d7d0a20206277612d6d656d322d616c69676e3a0a202020206377643a202f646174610a20202020696d6167653a0a2020202020207572693a207b7b2e436f6e7461696e6572496d616765207c2064656661756c742022646f636b65723a2f2f717561792e696f2f62696f636f6e7461696e6572732f6277612d6d656d323a322e322e312d2d68653531336663335f30227d7d0a202020206d6f756e74733a0a2020202020206277612d646174613a0a20202020202020206c6f636174696f6e3a202f646174610a20202020636f6d6d616e643a0a2020202020202d202f62696e2f626173680a2020202020202d20272d63270a2020202020202d207c0a20202020202020206966205b202d662073616d706c655f312e66617374712e677a205d3b207468656e0a2020202020202020202067756e7a6970202d662073616d706c655f312e66617374712e677a0a202020202020202066690a0a20202020202020206966205b202d662073616d706c655f322e66617374712e677a205d3b207468656e0a2020202020202020202067756e7a6970202d662073616d706c655f322e66617374712e677a0a202020202020202066690a0a20202020202020206966205b2021202d662073616d706c655f312e6661737471205d207c7c205b2021202d662073616d706c655f322e6661737471205d3b207468656e0a202020202020202020206578697420310a202020202020202066690a0a2020202020202020232041646420726561642067726f75702069662070726f76696465640a202020202020202052475f4f5054533d22220a20202020202020207b7b2d206966202e5265616447726f7570537472696e67207d7d0a202020202020202052475f4f5054533d222d5220277b7b2e5265616447726f7570537472696e677d7d27220a20202020202020207b7b2d20656e64207d7d0a0a2020202020202020232047657420616e79206164646974696f6e616c20616c69676e6d656e74206f7074696f6e730a202020202020202045585452415f4f5054533d227b7b2e416c69676e6d656e7445787472614f7074696f6e73207c2064656661756c742022227d7d220a0a2020202020202020232052756e204257412d4d454d3220616c69676e6d656e740a20202020202020206277612d6d656d32206d656d202d74207b7b2e416c69676e54687265616473207c2064656661756c742031367d7d20247b52475f4f5054537d20247b45585452415f4f5054537d207265666572656e63652e66612073616d706c655f312e66617374712073616d706c655f322e6661737471203e20616c69676e65642e73616d0a20202020202020200a20202020202020206563686f2022416c69676e6d656e7420446174653a202428646174652922203e20616c69676e65642e73746174732e7478740a20202020202020206563686f20225265666572656e63652047656e6f6d653a207b7b2e5265666572656e636547656e6f6d654e616d65207c2064656661756c7420224743465f3030303030353834352e325f41534d3538347632227d7d22203e3e20616c69676e65642e73746174732e7478740a2020202020202020746f74616c5f72656164733d242867726570202d7620225e402220616c69676e65642e73616d207c207763202d6c290a20202020202020206563686f2022546f74616c2072656164733a2024746f74616c5f726561647322203e3e20616c69676e65642e73746174732e7478740a20202020202020206d61707065645f72656164733d242867726570202d7620225e402220616c69676e65642e73616d207c2067726570202d76202258413a5a3a22207c207763202d6c290a20202020202020206563686f20224d61707065642072656164733a20246d61707065645f726561647322203e3e20616c69676e65642e73746174732e7478740a20202020202020206563686f202246696c652073697a65733a22203e3e20616c69676e65642e73746174732e7478740a20202020202020206475202d6820616c69676e65642e73616d203e3e20616c69676e65642e73746174732e7478740a2020202072657175697265733a0a2020202020202d206277612d6d656d322d696e6465780a202020207265736f757263653a0a2020202020206370753a0a2020202020202020636f7265733a207b7b2e416c69676e437075436f726573207c2064656661756c742031367d7d0a2020202020206d656d6f72793a0a202020202020202073697a653a207b7b2e416c69676e4d656d6f7279207c2064656661756c742031367d7d4769420a20206d73616d746f6f6c732d66696c7465723a0a202020206377643a202f646174610a20202020696d6167653a0a2020202020207572693a207b7b2e4d73616d746f6f6c73436f6e7461696e6572496d616765207c2064656661756c742022646f636b65723a2f2f717561792e696f2f62696f636f6e7461696e6572732f6d73616d746f6f6c733a312e312e322d2d68373133323637385f30227d7d0a202020206d6f756e74733a0a2020202020206277612d646174613a0a20202020202020206c6f636174696f6e3a202f646174610a20202020636f6d6d616e643a0a2020202020202d202f62696e2f626173680a2020202020202d20272d63270a2020202020202d207c0a202020202020202023205465737420766172696f75732066696c746572207468726573686f6c647320746f2066696e64207768617420776f726b730a20202020202020206d73616d746f6f6c732066696c746572202d53202d6c2031202d702031202d7a203120616c69676e65642e73616d203e20746573745f66696c74657265642e73616d0a2020202020202020746573745f636f756e743d242867726570202d7620225e402220746573745f66696c74657265642e73616d207c207763202d6c290a20202020202020200a20202020202020206d73616d746f6f6c732066696c746572202d53202d6c20333020616c69676e65642e73616d203e2066696c74657265645f6c33302e73616d0a20202020202020206c33305f636f756e743d242867726570202d7620225e40222066696c74657265645f6c33302e73616d207c207763202d6c290a20202020202020200a20202020202020206d73616d746f6f6c732066696c746572202d53202d6c203330202d7020383020616c69676e65642e73616d203e2066696c74657265645f6c33305f7038302e73616d0a20202020202020206c33307038305f636f756e743d242867726570202d7620225e40222066696c74657265645f6c33305f7038302e73616d207c207763202d6c290a20202020202020200a20202020202020206d73616d746f6f6c732066696c746572202d53202d6c203330202d70203830202d7a20353020616c69676e65642e73616d203e2066696c74657265645f6c33305f7038305f7a35302e73616d0a20202020202020206c33307038307a35305f636f756e743d242867726570202d7620225e40222066696c74657265645f6c33305f7038305f7a35302e73616d207c207763202d6c290a20202020202020200a20202020202020206966205b20246c33307038307a35305f636f756e74202d67742030205d3b207468656e0a2020202020202020202063702066696c74657265645f6c33305f7038305f7a35302e73616d2066696c74657265642e73616d0a202020202020202020206d696e5f6c656e6774683d33300a202020202020202020206d696e5f6964656e746974793d38300a202020202020202020206d696e5f616c69676e65643d35300a2020202020202020656c6966205b20246c33307038305f636f756e74202d67742030205d3b207468656e0a2020202020202020202063702066696c74657265645f6c33305f7038302e73616d2066696c74657265642e73616d0a202020202020202020206d696e5f6c656e6774683d33300a202020202020202020206d696e5f6964656e746974793d38300a202020202020202020206d696e5f616c69676e65643d300a2020202020202020656c6966205b20246c33305f636f756e74202d67742030205d3b207468656e0a2020202020202020202063702066696c74657265645f6c33302e73616d2066696c74657265642e73616d0a202020202020202020206d696e5f6c656e6774683d33300a202020202020202020206d696e5f6964656e746974793d300a202020202020202020206d696e5f616c69676e65643d300a2020202020202020656c73650a20202020202020202020637020746573745f66696c74657265642e73616d2066696c74657265642e73616d0a202020202020202020206d696e5f6c656e6774683d310a202020202020202020206d696e5f6964656e746974793d300a202020202020202020206d696e5f616c69676e65643d300a202020202020202066690a20202020202020200a202020202020202066696c74657265645f636f756e743d242867726570202d7620225e40222066696c74657265642e73616d207c207763202d6c290a20202020202020200a202020202020202023204164642066696c74657220696e666f20746f2073746174732066696c650a20202020202020206563686f202222203e3e20616c69676e65642e73746174732e7478740a20202020202020206563686f20224d53414d746f6f6c732046696c746572204170706c6965643a22203e3e20616c69676e65642e73746174732e7478740a20202020202020206563686f20222d204d696e696d756d206c656e6774683a20246d696e5f6c656e67746820627022203e3e20616c69676e65642e73746174732e7478740a20202020202020206966205b20246d696e5f6964656e74697479202d67742030205d3b207468656e0a202020202020202020206563686f20222d204d696e696d756d2070657263656e74206964656e746974793a20246d696e5f6964656e746974792522203e3e20616c69676e65642e73746174732e7478740a202020202020202066690a20202020202020206966205b20246d696e5f616c69676e6564202d67742030205d3b207468656e0a202020202020202020206563686f20222d204d696e696d756d20616c69676e6564206672616374696f6e3a20246d696e5f616c69676e65642522203e3e20616c69676e65642e73746174732e7478740a202020202020202066690a20202020202020206563686f202246696c74657265642072656164733a202466696c74657265645f636f756e7422203e3e20616c69676e65642e73746174732e7478740a20202020202020200a2020202020202020726d202d6620746573745f66696c74657265642e73616d2066696c74657265645f6c33302e73616d2066696c74657265645f6c33305f7038302e73616d2066696c74657265645f6c33305f7038305f7a35302e73616d0a2020202072657175697265733a0a2020202020202d206277612d6d656d322d616c69676e0a202020207265736f757263653a0a2020202020206370753a0a2020202020202020636f7265733a207b7b2e46696c746572437075436f726573207c2064656661756c7420347d7d0a2020202020206d656d6f72793a0a202020202020202073697a653a207b7b2e46696c7465724d656d6f7279207c2064656661756c7420387d7d476942" | xxd -r -p

ersion: v1
volumes:
  bwa-data:
    ingress:
      - source:
          uri: {{.ReferenceGenomeURL | default "https://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/000/005/845/GCF_000005845.2_ASM584v2/GCF_000005845.2_ASM584v2_genomic.fna.gz"}}
        destination:
          uri: file:///reference.fa.gz
      - source:
          uri: {{.Read1URL | default "https://ftp-trace.ncbi.nlm.nih.gov/giab/ftp/data/NA12878/Garvan_NA12878_HG001_HiSeq_Exome/NIST7035_TAAGGCGA_L001_R1_001.fastq.gz"}}
        destination:
          uri: file:///sample_1.fastq.gz
      - source:
          uri: {{.Read2URL | default "https://ftp-trace.ncbi.nlm.nih.gov/giab/ftp/data/NA12878/Garvan_NA12878_HG001_HiSeq_Exome/NIST7035_TAAGGCGA_L001_R2_001.fastq.gz"}}
        destination:
          uri: file:///sample_2.fastq.gz
    reference: volume://user/ephemeral
    egress:
      {{- range $source, $dest := dict "aligned.sam" "aligned.sam" "aligned.stats.txt" "aligned.stats.txt" "filtered.sam" "filtered.sam" }}
      - source:
          uri: file:///{{ $source }}
        destination:
          uri: {{$.EgressDestination | default (printf "s3://%s/%s%s" ($.S3Bucket | default "output-bucket") ($.S3Prefix | default "") $dest)}}
          {{- if $.S3Secret }}
          secret: {{ $.S3Secret }}
          {{- end }}
      {{- end }}
jobs:
  bwa-mem2-index:
    cwd: /data
    name: bwa-mem2-index
    image:
      uri: {{.ContainerImage | default "docker://quay.io/biocontainers/bwa-mem2:2.2.1--he513fc3_0"}}
    mounts:
      bwa-data:
        location: /data
    command:
      - /bin/bash
      - '-c'
      - |
        if [ -f reference.fa.gz ] && [ ! -f reference.fa ]; then
          gunzip -f reference.fa.gz
        fi

        if [ -f reference.fa ] && [ ! -f reference.fa.bwt.2bit.64 ]; then
          bwa-mem2 index reference.fa
        elif [ ! -f reference.fa ]; then
          exit 1
        fi
    resource:
      cpu:
        cores: {{.IndexCpuCores | default 16}}
      memory:
        size: {{.IndexMemory | default 16}}GiB
    id: job-{{.JobId | default "bwamem2"}}
  bwa-mem2-align:
    cwd: /data
    image:
      uri: {{.ContainerImage | default "docker://quay.io/biocontainers/bwa-mem2:2.2.1--he513fc3_0"}}
    mounts:
      bwa-data:
        location: /data
    command:
      - /bin/bash
      - '-c'
      - |
        if [ -f sample_1.fastq.gz ]; then
          gunzip -f sample_1.fastq.gz
        fi

        if [ -f sample_2.fastq.gz ]; then
          gunzip -f sample_2.fastq.gz
        fi

        if [ ! -f sample_1.fastq ] || [ ! -f sample_2.fastq ]; then
          exit 1
        fi

        # Add read group if provided
        RG_OPTS=""
        {{- if .ReadGroupString }}
        RG_OPTS="-R '{{.ReadGroupString}}'"
        {{- end }}

        # Get any additional alignment options
        EXTRA_OPTS="{{.AlignmentExtraOptions | default ""}}"

        # Run BWA-MEM2 alignment
        bwa-mem2 mem -t {{.AlignThreads | default 16}} ${RG_OPTS} ${EXTRA_OPTS} reference.fa sample_1.fastq sample_2.fastq > aligned.sam
        
        echo "Alignment Date: $(date)" > aligned.stats.txt
        echo "Reference Genome: {{.ReferenceGenomeName | default "GCF_000005845.2_ASM584v2"}}" >> aligned.stats.txt
        total_reads=$(grep -v "^@" aligned.sam | wc -l)
        echo "Total reads: $total_reads" >> aligned.stats.txt
        mapped_reads=$(grep -v "^@" aligned.sam | grep -v "XA:Z:" | wc -l)
        echo "Mapped reads: $mapped_reads" >> aligned.stats.txt
        echo "File sizes:" >> aligned.stats.txt
        du -h aligned.sam >> aligned.stats.txt
    requires:
      - bwa-mem2-index
    resource:
      cpu:
        cores: {{.AlignCpuCores | default 16}}
      memory:
        size: {{.AlignMemory | default 16}}GiB
  msamtools-filter:
    cwd: /data
    image:
      uri: {{.MsamtoolsContainerImage | default "docker://quay.io/biocontainers/msamtools:1.1.2--h7132678_0"}}
    mounts:
      bwa-data:
        location: /data
    command:
      - /bin/bash
      - '-c'
      - |
        # Test various filter thresholds to find what works
        msamtools filter -S -l 1 -p 1 -z 1 aligned.sam > test_filtered.sam
        test_count=$(grep -v "^@" test_filtered.sam | wc -l)
        
        msamtools filter -S -l 30 aligned.sam > filtered_l30.sam
        l30_count=$(grep -v "^@" filtered_l30.sam | wc -l)
        
        msamtools filter -S -l 30 -p 80 aligned.sam > filtered_l30_p80.sam
        l30p80_count=$(grep -v "^@" filtered_l30_p80.sam | wc -l)
        
        msamtools filter -S -l 30 -p 80 -z 50 aligned.sam > filtered_l30_p80_z50.sam
        l30p80z50_count=$(grep -v "^@" filtered_l30_p80_z50.sam | wc -l)
        
        if [ $l30p80z50_count -gt 0 ]; then
          cp filtered_l30_p80_z50.sam filtered.sam
          min_length=30
          min_identity=80
          min_aligned=50
        elif [ $l30p80_count -gt 0 ]; then
          cp filtered_l30_p80.sam filtered.sam
          min_length=30
          min_identity=80
          min_aligned=0
        elif [ $l30_count -gt 0 ]; then
          cp filtered_l30.sam filtered.sam
          min_length=30
          min_identity=0
          min_aligned=0
        else
          cp test_filtered.sam filtered.sam
          min_length=1
          min_identity=0
          min_aligned=0
        fi
        
        filtered_count=$(grep -v "^@" filtered.sam | wc -l)
        
        # Add filter info to stats file
        echo "" >> aligned.stats.txt
        echo "MSAMtools Filter Applied:" >> aligned.stats.txt
        echo "- Minimum length: $min_length bp" >> aligned.stats.txt
        if [ $min_identity -gt 0 ]; then
          echo "- Minimum percent identity: $min_identity%" >> aligned.stats.txt
        fi
        if [ $min_aligned -gt 0 ]; then
          echo "- Minimum aligned fraction: $min_aligned%" >> aligned.stats.txt
        fi
        echo "Filtered reads: $filtered_count" >> aligned.stats.txt
        
        rm -f test_filtered.sam filtered_l30.sam filtered_l30_p80.sam filtered_l30_p80_z50.sam
    requires:
      - bwa-mem2-align
    resource:
      cpu:
        cores: {{.FilterCpuCores | default 4}}
      memory:
        size: {{.FilterMemory | default 8}}GiB